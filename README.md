# Kifuuuuuuwarabe Beginning

第３５回世界コンピュータ将棋選手権に出るつもりのきふわらべ  

* 情報
    * 📖 [第35回世界コンピュータ将棋選手権](http://www2.computer-shogi.org/wcsc35/)
* Kifuuuuuuwarabe Beginning 説明書
    * 📖 [インストール手順](./docs/how_to_install.md)
    * 📖 [実行手順](./docs/how_to_start.md)


## 雑記

| 用語 | 読み方 | 意味               | 席                 |
|------|--------|--------------------|--------------------|
| 先手 | せんて | 平手で先に指す方   | 将棋盤の９段目の方 |
| 後手 | ごて   | 平手で後に指す方   | 将棋盤の１段目の方 |
| 上手 | うわて | 駒落ちで先に指す方 | 将棋盤の１段目の方 |
| 下手 | したて | 駒落ちで後に指す方 | 将棋盤の９段目の方 |

平手、駒落ちに関わらず、将棋盤の９段目の方に座っているプレイヤーを指す言葉が欲しいが、無い。  
［９段目の方］ `nine_rank_side_perspective` 略して `np` という単語を造語して使う。NumPyの略ではない。  
いわゆる先手視点だが、紛れを無くしておく。  

この　きふわらべ　では、常に［９段目の方］の視点でプログラミングしていく。  
これは大盤解説の視点と同じ。  

| きふわらべ用語 | 読み方 | 本来の意味 | 意味     |
|----------------|--------|------------|----------|
| Earth          | イース | 地球       | 自分     |
| Mars           | マーズ | 火星       | 対戦相手 |


### TODO 駒表記

TODO 地球はどうぶつ将棋、火星は将棋表記。後手は左に `v` が付く。

|地球|火星|
|----|----|
|ひ  |歩  |
|猪  |香  |
|兎  |桂  |
|猫  |銀  |
|犬  |金  |
|獅  |玉  |
|象  |角  |
|麒  |飛  |
|鶏  |と  |
|イ  |杏  |
|ウ  |圭  |
|ネ  |全  |
|ゾ  |馬  |
|キ  |竜  |


### TODO

* 宣言に関して
    * [ ] 入玉宣言勝ちしてない
* 基本機能に関して
    * [x] 一手詰めを BackwardsPlotModel に入れたい。
    * [x] 地球と火星の区別を無くす PtolemaicTheoryModel が欲しい。
    * [x] ひとまず、指し手について、ログに残してはどうか。
* 拡張コマンドに関して
    * [ ] xs_board コマンド作成
    * [x] 指定の指し手だけ静止探索するコマンドが欲しい。 `go_qs` とか。
* 探索全般に関して
    * [ ] 通常探索、静止探索、王手延長探索の３つに分けたい。
* 静止探索に関して
    * [ ] 静止探索の中で、１手目が駒を取らない手のときには、２手目も駒を取らない手（打を含みたい）も探索対象にしたい。
    * [ ] 静止探索に時間がかかりすぎている。ノード数を調べたい。
        * [ ] 打つ手は、駒１つ調べれば他の駒種類も同様なのでは？
    * [ ] 駒を打つ手は、３手目に駒が取れるとか、そういう駒取りに絡む手を指してほしい。
    * [ ] ベータカットしたい
    * [ ] 放置していると、ただで他の駒を取られる状況を評価してない。
    * [ ] このソフトでの静止探索は、［負数をカットする］［非整数しかなければベスト値を取る］のが役割。
    * [ ] 探索のツリー構造のログが見たい。
    * [ ] 王手の時は静止探索を延長したい。
    * [x] TODO お互いが馬や竜を作り、取り返さず、取り続けた場合、静止探索は全駒とはいかないまでも、かなり長くなる。従って、取った駒を取り返すことを第一に考える制約を付けたい。 --> filtering_same_destination_move_list()。
    * [ ] リボーカー（Revoker）コレクションを作りたい。それを枝前処理として１箇所に置きたい。各ルールは枝前処理で、その結果を参照するだけにしたい。
* 盤上の駒の指し手に関して
    * [ ] 金が三角形の動きをする手待ちを止めさせたい。
    * [x] ゾウ、ウサギの頭のヒヨコを突くのを止めさせたい。
* 打に関して
    * [x] 自陣に意味のない飛車を打つのを止めさせたい。---> 一律、自陣に飛車を打たせないことにする。
    * [ ] そっぽに駒を集めるのを止めさせたい。
        * [ ] 自玉、敵玉に金銀を寄せるルールを一般化したい。
            * [ ] （振り飛車の方針上）自玉は、先手視点で自陣の左辺に寄ることはないという制約を付けてよい。入玉があるので自陣より上については言及しない。
                * [ ] 任意のマスＡについて、自玉、敵玉とのチェビシェフ距離を算出したい。
    * [ ] 歩で間駒した方が得なときに、間駒してくれない。
* 入玉に関して
    * [ ] と金が１段目に入ることがあるが、と金より先に玉を１段目に入れたい。
* ポジティブ・ルール案
    * [x] 号令［相手が手を戻したら自分も戻せ］
* ネガティブ・ルール案
    * [x] 打つな。打つのは静止探索の結果によってだけにする。
* ログについて
    * [x] ポジティブ・ルールで選ばれた指し手も出したい。


## FIXME

* 静止探索中
    * [ ] 火星が、キリンではなくヒヨコを取る手を優先した。明らかにキリンを取る方が得だが。
* 指し手に関して
    * [ ] **FIXME** ８九の桂が７七に跳ねると、象頭の守りの邪魔になることが多いから止めさせたい。
    * [ ] **FIXME** 敵玉から自駒の鶏が離れていく手を止めさせたい。
* ネガティブ・ルールに関して
    * [ ] **FIXME** ［戻るな］コマンドは、利きを受けている駒は適用除外にしたい。
        * [ ] スタンプ・カウント・シートを作る。探索中の２手目に駒の移動先になったマスはその回数を記憶する。０より大きければ、そのマスの駒は取られる可能性がある？
* その他
    * [ ] 駒の取り合いは［後ろ向き］ではなく［前向き］で探索しないとおかしくなるのでは？ 後ろの方で実現しない枝を選んでる。
    * [ ] **FIXME** 落ちてる歩を守るより、自陣に駒を打たせない方が得、というのが見えてない。
    * [ ] **FIXME** 質駒があるとき、駒を取ることを過小評価してしまう？
    * [ ] 後手、ネガティブ・ルールが効かなくなってる。QSの凡手が邪魔してるかも。要確認。
        * [ ] ［他に負の点がない］ときの［駒を取らない］［０点の手］はリストから除外しているか？
    * [ ] 初手で駒を取らず、残りの２手で駒を取る場合、初手の無駄な動きに駒得の点が入ることがある。これでは、初手は出鱈目になってしまう。初手の貢献度、必然性を判定できないか？
        * [x] 初手で駒を取らなかったケースは、探索深さを一手延長する
    * [ ] 駒の取り合いは、自分と相手を１組みとしないと、不公平になる。
        * [ ] 駒の価値の逓減は、自分と相手で１組にしたい。
    * [ ] 駒をポンポン打ってしまう。駒を打つことに対してネガティブ・ルールを書いてないから。
    * [ ] 駒を取らない手を指すと、相手が飛車で歩を取るので、同角とする、のようなあり得ない読み筋がある。
    * [ ] 歩の前に象が移動する手を指すが、自分の象が取り返される手より、他の駒が［ひ］を取る手を読んでいる。
    * [ ] 読みの末端で、飛がタダで突っ込んできて［ひ］を取るので同象して高い点だ、と判定していることがある。


## 原則集

* ＜📚原則１＞ 駒の取り合いの点数計算は、自分と相手の２手１組で１つの単位とする必要がある。
* ＜📚原則２＞ 静止探索の中にて、王手は（駒を取らない手だが）除外せず、探索を続け、深さを１手延長する。
    * ＜📚原則２補足１＞ 探索がきちんと作れていない場合、勝手読みが増えてしまい、却って弱くなる。


## NOTE

* [ ] `cshogi.move_from_piece_type(move)` は、打には使えない。 `cshogi.move_drop_hand_piece(move)` と使い分けてください。